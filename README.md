# VKBOT / Простая библиотека для создания бота
>Библиотека находится на стадии разработки, но уже юзабельна :grin:

> ### <b>:warning: В ближайшем будущем, библиотека будет переписана на многопоток! (Ну а пока-что так.) :warning:</b>

[СПИСОК МЕТОДОВ](https://github.com/FunnyRain/vkbot/blob/master/METHODS.md) - https://github.com/FunnyRain/vkbot/blob/master/METHODS.md
### Что есть?
  - Обработка команд
  - Работа с кнопками
  - Работа с конфигом
  - Обработка событий
  - Загрузка документов
  - Обработка стены сообщества (Получение сообщения с комметариев)
  - Bots LongPoll API
  - User LongPoll API
  - CallBack API

### Что планируется?

  - Рассылка сообщений
  - Создание виджета
  - Переписать Callback кнопки

### Примеры

  - [Отправка сообщения по команде](https://github.com/FunnyRain/vkbot#%D0%BF%D1%80%D0%BE%D1%81%D1%82%D0%BE%D0%B9-%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80-%D0%BE%D1%82%D0%BF%D1%80%D0%B0%D0%B2%D0%BA%D0%B8-%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BD%D0%B0-%D0%BA%D0%BE%D0%BC%D0%B0%D0%BD%D0%B4%D1%83-info)
  - [Отправка клавиатуры и обработка](https://github.com/FunnyRain/vkbot#%D0%BF%D1%80%D0%BE%D1%81%D1%82%D0%BE%D0%B9-%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80-%D0%BE%D1%82%D0%BF%D1%80%D0%B0%D0%B2%D0%BA%D0%B8-%D0%BA%D0%BB%D0%B0%D0%B2%D0%B8%D0%B0%D1%82%D1%83%D1%80%D1%8B-%D0%B8-%D0%BE%D0%B1%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0)
  - [Вставка Имя/Фамилия в сообщении](https://github.com/FunnyRain/vkbot#%D0%BF%D1%80%D0%BE%D1%81%D1%82%D0%BE%D0%B9-%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80-%D0%B2%D1%81%D1%82%D0%B0%D0%B2%D0%BA%D0%B8-%D0%B8%D0%BC%D1%8F--%D1%84%D0%B0%D0%BC%D0%B8%D0%BB%D0%B8%D0%B8-%D0%B2-%D1%82%D0%B5%D0%BA%D1%81%D1%82-%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D1%8F)
  - [Работа с конфигом](https://github.com/FunnyRain/vkbot#%D0%BF%D1%80%D0%BE%D1%81%D1%82%D0%BE%D0%B9-%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B-%D1%81-%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D0%BE%D0%BC)
  - [Обработка событий](https://github.com/FunnyRain/vkbot#%D0%BF%D1%80%D0%BE%D1%81%D1%82%D0%BE%D0%B9-%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-%D1%81%D0%BE%D0%B1%D1%8B%D1%82%D0%B8%D0%B9-%D0%B2-%D0%B1%D0%B5%D1%81%D0%B5%D0%B4%D0%B0%D1%85)
  - [Загрузка документов](https://github.com/FunnyRain/vkbot#%D0%BF%D1%80%D0%BE%D1%81%D1%82%D0%BE%D0%B9-%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80-%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B8-%D1%84%D0%BE%D1%82%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D0%B8--%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0-%D0%B8%D0%B7-%D0%B4%D0%B8%D1%80%D0%B5%D0%BA%D1%82%D0%BE%D1%80%D0%B8%D0%B8)
  - [Обработка стены сообщества](https://github.com/FunnyRain/vkbot#%D0%BF%D1%80%D0%BE%D1%81%D1%82%D0%BE%D0%B9-%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80-%D0%BF%D0%BE%D0%BB%D1%83%D1%87%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BA%D0%BE%D0%BC%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%80%D0%B8%D1%8F-%D0%B8-%D0%BE%D1%82%D0%B2%D0%B5%D1%82%D0%B0-%D0%BD%D0%B0-%D0%BD%D0%B5%D0%B3%D0%BE)
  - [Работа с CallBack API](https://github.com/FunnyRain/vkbot#%D0%BF%D1%80%D0%BE%D1%81%D1%82%D0%BE%D0%B9-%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80-%D0%BF%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D1%8F-callback-api)

### Как установить?
Пиши в консоль:
```bash
git clone https://github.com/FunnyRain/vkbot
```
```bash
cd vkbot
```
После, нужно настроить `Main.php` 
```php
$bot = new Control(
    "тут твой супер секретный токен",
    "айди группы (обязательно цифрами)"
);
```
Далее, пиши в консоль
```bash
php Main.php
```
Ну и готово :) твой бот запущен, приятного использования моей библиотеки.
### Рекомендуемые типы событий в сообществе
![Сообщения: Входящее сообщение](https://i.imgur.com/1vvUxZ1.png)
![Комментарии на стене: Добавление](https://i.imgur.com/5EhrjJa.png)
### Примеры использования
###### Простой пример отправки сообщения на команду "info":
```php
require_once __DIR__ . '/autoload.php'; // подключаем библиотеку
$bot = new Control(
    "токен",
    "айди группы (цифрами)"
);
while (true) {
    $bot->start(); // активируем LongPoll
    $text = $bot->getMessage(); // получаем сообщение
    $message_id = $bot->getMessageId();
    $from_id = $bot->getFromId(); // получаем айди отправителя
    $peer_id = $bot->getPeerId(); // получаем айди переписки
    if ($text == "info") {
        $bot->message->sendMessage("Тебя зовут {fname}", $peer_id, $from_id); // отправляем сообщение
    }
}
```
###### Простой пример отправки клавиатуры и обработка
```php
require_once __DIR__ . '/autoload.php';
$bot = new Control(
    "токен",
    "айди группы (цифрами)"
);
while (true) {
    $bot->start(); // активируем LongPoll
    $text = $bot->getMessage(); // получаем сообщение
    $message_id = $bot->getMessageId();
    $from_id = $bot->getFromId(); // получаем айди отправителя
    $peer_id = $bot->getPeerId(); // получаем айди переписки
    $payload = $bot->getPayload(); // получаем payload
    $color = new ReflectionClass("Message");
    $color = $color->getConstants();
    if ($text == "keyboard") {
        $bot->message->addKeyboard([
            [$bot->message->addButton(">нажми на меня<", $color['green'], "press_button")]
        ]); // создаём клавиатуру
        $bot->message->sendMessage("нажми на кнопочку :)", $peer_id, $from_id, ["keyboard" => $bot->message->getKeyboard()]);
        // отправляем сообщение с клавиатурой
    } elseif ($payload == "press_button") {
        $bot->message->sendMessage("ты нажал на кнопку", $peer_id, $from_id); // отправляем сообщение
    }
}
```
###### Простой пример вставки Имя / Фамилии в текст сообщения
```php
require_once __DIR__ . '/autoload.php'; // подключаем библиотеку
$bot = new Control(
    "токен",
    "айди группы (цифрами)"
);
while (true) {
    $bot->start(); // активируем LongPoll
    $text = $bot->getMessage(); // получаем сообщение
    $message_id = $bot->getMessageId();
    $from_id = $bot->getFromId(); // получаем айди отправителя
    $peer_id = $bot->getPeerId(); // получаем айди переписки
    if ($text == "info") {
        $text = "* {fname} - имя
        * {lname} - фамилия
        * {fullname} - имя и фамилия
        * {afname} - имя в виде ссылки  (т.е кликабельное)
        * {alname} - фамилия в виде ссылки (т.е кликабельное)
        * {afullname} - имя и фамилия в виде ссылки (т.е кликабельное)";
        $bot->message->sendMessage($text, $peer_id, $from_id); // отправляем сообщение
    }
}
```
###### Простой пример работы с конфигом
```php
require_once __DIR__ . '/autoload.php'; // подключаем библиотеку
$bot = new Control(
    "токен",
    "айди группы (цифрами)"
);
while (true) {
    $bot->start(); // активируем LongPoll
    $text = $bot->getMessage(); // получаем сообщение
    $message_id = $bot->getMessageId();
    $from_id = $bot->getFromId(); // получаем айди отправителя
    $peer_id = $bot->getPeerId(); // получаем айди переписки

    /** Работа с конфигом, создание данных пользователя
     * Проверяем папку для хранения данных. Если нету - создаём */
    if (!is_dir(__DIR__ . '/users/'))
        @mkdir(__DIR__ . '/users/');
    /**  Проверяем наличие аккаунта. Если нету - создаём */
    if (!file_exists(__DIR__ . '/users/' . $from_id . '.json')) {
        /** Назначаем данные,
         * id - id пользователя
         * money - баланс */
        $cfg = new Config(__DIR__ . '/users/' . $from_id . '.json', Config::JSON, [
            'id' => $from_id,
            'money' => 1000
        ]);
        $bot->message->sendMessage("аккаунт создан", $peer_id, $from_id);
    } else $cfg = new Config(__DIR__ . '/users/' . $from_id . '.json');

    if ($text == "баланс") {
        /** получаем текущий баланс */
        $bot->message->sendMessage("Твой баланс: " . $cfg->get("money"), $peer_id, $from_id);
    } elseif ($text == "прибавить") {
        /** прибавляем 100 к текущему балансу */
        $cfg->set("money", $cfg->get("money") + 100);
        $cfg->save();
        $bot->message->sendMessage("+100 к балансу", $peer_id, $from_id);
    } elseif ($text == "уменьшить") {
        /** уменьшаем 100 от текущего баланса */
        $cfg->set("money", $cfg->get("money") - 100);
        $cfg->save();
        $bot->message->sendMessage("-100 от балансу", $peer_id, $from_id);
    }
}
```
###### Простой пример использования событий в беседах
```php
require_once __DIR__ . '/autoload.php'; // подключаем библиотеку
$bot = new Control(
    "токен",
    "айди группы (цифрами)"
);
while (true) {
    $bot->start(); // активируем LongPoll
    $text = $bot->getMessage(); // получаем сообщение
    $message_id = $bot->getMessageId();
    $from_id = $bot->getFromId(); // получаем айди отправителя
    $peer_id = $bot->getPeerId(); // получаем айди переписки
    $action = $bot->getAction(); // получаем событие

    /**
     * Обработка событий (в примере Добавление группы в беседу)
     * https://vk.com/dev/_objects_message (action)
     */
    if ($action["type"] == "chat_invite_user") {
        if ($action["member_id"] == -$bot->group_id) {
            $bot->message->sendMessage("вы добавили бота (меня) в беседу, всем привет :)", $peer_id, $from_id);
        } else {
            $message = "привет, {fname} {lname}! тебя добавили в беседу";
            $replace = $bot->message->replaceNameToMessage($action["member_id"], $message);
            $bot->message->sendMessage($replace, $peer_id, $from_id);
        }
    }
}
```
###### Простой пример загрузки Фотографии / Документа из директории
```php
require_once __DIR__ . '/autoload.php'; // подключаем библиотеку
$bot = new Control(
    "токен",
    "айди группы (цифрами)"
);
while (true) {
    $bot->start(); // активируем LongPoll
    $text = $bot->getMessage(); // получаем сообщение
    $message_id = $bot->getMessageId();
    $from_id = $bot->getFromId(); // получаем айди отправителя
    $peer_id = $bot->getPeerId(); // получаем айди переписки
    if ($text == "photo") {
        /** загрузка фотографии из директории */
        $bot->message->sendMessage("1 фотография", $peer_id, $from_id, [
            "attachment" => $bot->message->uploadPhoto(__DIR__ . '/test.jpeg')
        ]);
        /** загрузка нескольких фотографий из директории */
        $bot->message->sendMessage("3 фотографии", $peer_id, $from_id, [
            "attachment" => [
                $bot->message->uploadPhoto(__DIR__ . '/test.jpeg'),
                $bot->message->uploadPhoto(__DIR__ . '/test.jpeg'),
                $bot->message->uploadPhoto(__DIR__ . '/test.jpeg')
            ]
        ]);
    } elseif ($text == "doc") {
        /** загрузка фотографии и документа из директории */
        $bot->message->sendMessage("Фотография и Документ", $peer_id, $from_id, [
            "attachment" => [
                $bot->message->uploadPhoto(__DIR__ . '/test.jpeg'),
                $bot->message->uploadDoc(__DIR__ . '/test.jpeg')
            ]
        ]);
    }
}
```
###### Простой пример получения комментария и ответа на него
```php
require_once __DIR__ . '/autoload.php'; // подключаем библиотеку
$bot = new Control(
    "токен",
    "айди группы (цифрами)"
);
while (true) {
    $bot->start(); // активируем LongPoll
    $comment_message = $bot->wall->getMessage();
    $comment_postid = $bot->wall->getPostId();
    $comment_id = $bot->wall->getCommentId();
    $bot->debug(1);
    if ($comment_message == "test") {
        $bot->wall->sendComment("* {fname} - имя
        * {lname} - фамилия
        * {fullname} - имя и фамилия
        * {afname} - имя в виде ссылки  (т.е кликабельное)
        * {alname} - фамилия в виде ссылки (т.е кликабельное)
        * {afullname} - имя и фамилия в виде ссылки (т.е кликабельное)");
    }
}
```
###### Простой пример подключения CallBack API
```php
require_once __DIR__ . '/autoload.php';

$bot = new Control(
    "токен",
    "айди группы (цифрами)",
);
$bot->setConfirm("Строка, которую должен вернуть сервер");
$bot->start();
$text = $bot->getMessage();
$from_id = $bot->getFromId();
$peer_id = $bot->getPeerId();
$bot->message->sendMessage($text, $peer_id, $from_id);
```
### Если есть вопросы, пишите [VKontakte](https://vk.com/vyxel)